#!/bin/bash
# Pre-commit hook: Beads sync + TODO tracking validation
#
# This hook combines:
# 1. Beads database sync (ensures DB is current before querying)
# 2. TODO comment validation (ensures all TODOs have tracked beads)
#
# INSTALLATION (per-project, NOT global):
#   cp dot-git-hooks(Project-Local)/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# WARNING: Do NOT use global hooks (git config --global core.hooksPath)
# Global hooks override local hooks and break beads' built-in hooks
# (post-checkout, post-merge, pre-push) which handle JSONL sync.
#
# For projects using beads issue tracking.
# Skips gracefully for non-beads projects.

# Only run if this project uses beads
if [ ! -d ".beads" ]; then
    exit 0
fi

# ============================================
# PART 1: BEADS SYNC (from official beads hook)
# Ensures database is synced before we query it
# ============================================

if command -v bd >/dev/null 2>&1; then
    # Import latest JSONL to database (handles post-checkout/merge sync)
    # This fixes "Database out of sync with JSONL" errors
    if ! bd sync --import-only --no-git-history >/dev/null 2>&1; then
        echo "Warning: Failed to import beads JSONL" >&2
    fi

    # Flush any pending DB changes to JSONL
    if ! bd sync --flush-only >/dev/null 2>&1; then
        echo "Warning: Failed to flush beads changes" >&2
    fi

    # Stage the JSONL if modified
    if [ -f ".beads/issues.jsonl" ]; then
        git add ".beads/issues.jsonl" 2>/dev/null || true
    fi
    if [ -f ".beads/deletions.jsonl" ]; then
        git add ".beads/deletions.jsonl" 2>/dev/null || true
    fi
fi

# ============================================
# PART 2: TODO VALIDATION
# Ensures all TODO comments have tracked beads
# ============================================

echo "ğŸ” Validating TODO tracking..."

# Scan for TODO comments with bead IDs
INVALID_TODOS=$(rg "TODO\(|FIXME\(|HACK\(|XXX\(" \
  --type ts --type js \
  --line-number \
  --no-heading \
  --color never \
  2>/dev/null | while IFS=: read -r file line comment; do

  # Extract bead ID from comment
  BEAD_ID=$(echo "$comment" | grep -oE '(TODO|FIXME|HACK|XXX)\(([a-z]+-[a-z0-9]+)\)' | grep -oE '[a-z]+-[a-z0-9]+')

  if [[ -z "$BEAD_ID" ]]; then
    echo "$file:$line - MISSING BEAD ID - $comment"
  else
    # Check if bead exists and is open
    BEAD_STATUS=$(bd list --json 2>/dev/null | jq -r --arg id "$BEAD_ID" '.[] | select(.id == $id) | .status')

    if [[ -z "$BEAD_STATUS" ]]; then
      echo "$file:$line - BEAD NOT FOUND ($BEAD_ID) - $comment"
    elif [[ "$BEAD_STATUS" == "closed" ]]; then
      echo "$file:$line - BEAD CLOSED ($BEAD_ID) - $comment"
    fi
  fi
done)

if [[ -n "$INVALID_TODOS" ]]; then
  echo ""
  echo "âŒ ERROR: Invalid TODO comments found:"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "$INVALID_TODOS"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "Fix by:"
  echo "  MISSING BEAD ID: Format must be TODO(nad-XXX): description"
  echo "  BEAD NOT FOUND: Create bead or remove comment"
  echo "  BEAD CLOSED: Remove comment from code"
  echo ""
  echo "Create beads with:"
  echo "  ISSUE_ID=\$(bd create \"Complete: [description]\" -t task -p 1 --json | jq -r '.id')"
  echo "  # Use in comment: TODO(\$ISSUE_ID): description"
  echo ""
  exit 1
fi

echo "âœ… All TODO comments tracked in beads"
exit 0
